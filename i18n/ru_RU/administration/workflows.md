# Рабочие потоки (Workflows)

Функция Workflows доступна в [Advanced Pack](https://www.espocrm.com/extensions/advanced-pack/)

Функция Workflows автоматизирует ваш бизнес-процесс простым способом. Вы можете найти ее на панели администрирования. Чтобы создать правило рабочего потока, вам необходимо определить:

* Целевую сущность - к какому типу сущности применяется рабочий поток;
* Тип триггера - при срабатывании рабочего потока;
* Условия - условия должны быть выполнены для запуска рабочего потока;
* Действия - что необходимо делать, если рабочий поток запускается


## Типы триггеров

### После создания записи

Выполняется только при создании новой записи. Если указанные условия выполнены, то действия будут выполнены.

### После сохранения записи

Запускается при создании новой записи или обновлении существующей записи. Если указанные условия выполнены, то действия будут выполнены.

Для правил рабочих потоков с этим типом триггера обычно принято соблюдать условие, которое проверяет, было ли какое-то поле «изменено». Например, если статус обращения изменен, выполните некоторые действия.

### Запланированый (Scheduled)

Выполняется в соответствии с заданным расписанием. Вы можете настроить его для запуска каждый день, каждую неделю и т. д. Действия будут применяться для записей, возвращаемых указанным отчетом-списком. Поэтому вам также нужно создать отчет-список.

Планирование указано в нотации crontab.

```
* * * * * *
| | | | | | 
| | | | | +-- Год              (range: 1900-3000)
| | | | +---- День недели      (range: 1-7, 1 standing for Monday)
| | | +------ Месяц года       (range: 1-12)
| | +-------- День месяца      (range: 1-31)
| +---------- Час              (range: 0-23)
+------------ Минута           (range: 0-59)
```

### Последовательный (Sequential)

Используется редко. Предполагается, что будет запущен другим рабочим потоком. Предоставляет возможность создавать сложную логику.

Примечание: Для последовательных рабочих потоков рекомендуется использовать [инструмент BPM](bpm.md), а не функцию Workflow.

## Условия

Вы можете указать условия, которые должны выполняться для запуска рабочего потока. Существует два способа определения условий: с конструктором условий пользовательского интерфейса и с формулой.

### Конструктор условий пользовательского интерфейса

Некоторые доступные типы условий:

* _равно_ - поле равно конкретному значению или значению другого поля;
* _было равным_ - поле было равно определенному значению до запуска рабочего потока;
* _не равно_ - поле не равно конкретному значению или значению другого поля;
* _не было равным_ - поле не было равно конкретному значению до запуска рабочего потока;
* _пустое_ - значение поля пусто;
* _не пустое_ - значение поля не пусто;
* _изменено_ - поле было изменено;
* _не изменено_ - поле не было изменено.

### Условия формулы

Формула дает возможность определять условия любой сложности. Чтобы прочитать синтаксис формулы, следуйте [этой статье](formula.md).

Примечание. В определении кода не должно быть никакого разделителя `;`, если он определяет условие.

## Действия

### Отправить письмо

Система отправит электронное письмо с использованием указанного шаблона электронной почты. Адрес электронной почты получателя может быть взят из целевой записи, любой связанной записи, текущего пользователя, последователей, пользователей команды или который непосредственно Вами указан. Сообщение может быть отправлено незамедлительно или отложено на определенный временный интервал.

### Создать сущность

Система создаст новую запись любого типа сущности. Если есть связь между целевой записью и созданием записи, можно связать записи.

Существует возможность определять формулу для вычисления полей.

### Создать связанную сущность

Система создаст запись, относящуюся к целевой записи. Можно определить формулу для вычисления полей.

### Обновить целевую сущность

Позволяет изменять определенные поля целевой записи. Можно определить формулу для вычисления полей.

Если вам нужно добавить новые элементы в поле Link-Multiple без потери существующих данных (например, для команд), вам необходимо использовать функцию function entity\addLinkMultipleId. Пример: `entity\addLinkMultipleId ('teams', 'teamId')`.

### Обновить соответствующую сущность

Позволяет изменять определенные поля соответствующей записи или записей. Можно определить формулу для вычисления полей.

### Связать с другой сущностью (Link with Another Record)

Связывает целевой объект с другим конкретным объектом. Например: добавляет конкретную команду к записи.

### Отменить связь с другой сущностью (Unlink with Another Record)

Отделяет целевой объект от другого конкретного объекта. Например: удаляет определенную команду из записи.

### Применить правило назначения (Apply Assignment Rule)

Назначьте целевую запись пользователю по правилу распределения. Существуют два доступных правила: Round-Robin и Less-Busy.

* Round-Robin - пользователи выбираются сверху вниз по списку (группе) и затем это начинается снова.
* Less-Busy - пользователь, у которого меньше назначенных записей, будет выбран для назначения.

_Отчет-список_ - для распределения по Least-Busy определяет, какие записи будут приняты во внимание для расчета количества присвоенных записей. Например: для обращений нам нужно брать только записи с активным статусом.

### Создать оповещение

Уведомлять определенных пользователей с сообщением. В шаблоне сообщения можно использовать заполнители: {entity} - целевая запись, {user} - текущий пользователь.

### Подписать

Подписывает конкретных пользователей на целевой объект или конкретный связанный объект.

### Запуск другого рабочего потока (Trigger Another Workflow)

Позволяет создавать последовательные рабочие потоки. Можно разделить рабочий поток по условию: вы можете настроить рабочий поток для запуска двух рабочих потоков с разными условиями, определенными в этих рабочих котоках.

Можно отложить выполнение последовательного рабочего потока. В последовательном рабочем потоке вы можете определить условие, которое проверяет, были ли изменены указанные поля, поскольку родительский рабочий поток был запущен с использованием типов условий _Изменено_ и _Было равным_.

Примечание. Для последовательных рабочих потоков рекомендуется использовать [BPM-инструмент](bpm.md), а не функцию Workflow.

### Run Service Action

Позволяет запускать определенные сервисные скрипты. По умолчанию доступны следующие действия:

* Отправить приглашения - для встреч/звонков;
* Добавить Quote Item - для предложений.

Разработчики могут писать свои собственные сервисные действия. См. [Подробнее](../ development/workflow-service-actions.md).

## Использование формул в Действиях

Можно определить формулу для вычисления полей для создания записи, обновления целевой записи, создания соответствующей записи, обновления соответствующей записи. Для последних двух, чтобы получить доступ к атрибутам целевого объекта, вы должны использовать функцию `targetEntity\attribute`. Чтобы получить доступ к атрибутам целевого объекта, который был установлен до запуска рабочего потока, используйте функцию `targetEntity\attributeFetched`.

Например:
```
name = string\concatenate(targetEntity\attribute('name'), ' ', datetime\today());
```
